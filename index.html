<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart School Pro - Ultimate Learning Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --primary: #58a6ff;
            --success: #238636; --error: #da3633; --text: #c9d1d9;
            --opt-bg: #21262d; --border: #30363d;
        }
        body { font-family: 'Segoe UI', 'Pothana', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; line-height: 1.6; }
        .container { max-width: 800px; margin: auto; }
        .card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid var(--border); box-shadow: 0 8px 24px rgba(0,0,0,0.5); margin-bottom: 20px; }
        h2, h3 { color: var(--primary); text-align: center; }
        
        .grid-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .menu-btn { background: var(--opt-bg); border: 1px solid var(--border); color: white; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.3s; text-align: center; }
        .menu-btn:hover { background: var(--primary); color: #000; transform: translateY(-3px); }
        
        input, select { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border); background: #0d1117; color: white; box-sizing: border-box; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #0d1117; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 1.5em; font-weight: bold; color: var(--primary); display: block; }

        .option { background: var(--opt-bg); padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; position: relative; }
        .correct { border-color: var(--success) !important; background: rgba(35, 134, 54, 0.2) !important; }
        .wrong { border-color: var(--error) !important; background: rgba(218, 54, 51, 0.2) !important; }
        
        .explanation { font-size: 0.85em; color: #8b949e; margin-top: 10px; display: none; padding-top: 8px; border-top: 1px solid var(--border); }
        
        .progress-container { width: 100%; background: #30363d; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: 0.4s; }
        
        .timer-box { text-align: right; font-weight: bold; color: #f85149; font-size: 1.1em; }
        .action-btn { background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 15px; font-size: 16px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="setupScreen" class="card">
        <h2>Smart School Pro Setup</h2>
        <label>ඔබේ ශ්‍රේණිය:</label>
        <select id="gradeSelect" onchange="updateUI()">
            <option value="6">Grade 6</option><option value="7">Grade 7</option>
            <option value="8">Grade 8</option><option value="9">Grade 9</option>
            <option value="10">Grade 10</option><option value="11">Grade 11 (O/L)</option>
            <option value="AL">Advanced Level (A/L)</option>
        </select>

        <div id="alStreamDiv" class="hidden">
            <label>විෂය ධාරාව (Stream):</label>
            <select id="streamSelect">
                <option value="Bio">Bio Science</option>
                <option value="Maths">Physical Science (Maths)</option>
                <option value="Art">Art</option>
                <option value="Commerce">Commerce</option>
                <option value="Tech">Technology</option>
            </select>
        </div>

        <label>විභාගයට ඉතිරි දින ගණන:</label>
        <input type="number" id="daysGoal" placeholder="උදා: 100">
        
        <button class="action-btn" onclick="saveSetup()">ආරම්භ කරන්න</button>
    </div>

    <div id="dashboard" class="card hidden">
        <h2 id="userGradeHead">මගේ ප්‍රගතිය</h2>
        <div class="stats-grid">
            <div class="stat-box">ඉතිරි දින<span id="dLeft" class="stat-val">0</span></div>
            <div class="stat-box">මුළු ලකුණු<span id="tScore" class="stat-val">0</span></div>
        </div>
        <div style="height: 250px; position: relative;"><canvas id="progChart"></canvas></div>
        <h3 style="text-align: left; margin-top: 20px;">විෂය තෝරන්න:</h3>
        <div id="subjectGrid" class="grid-menu"></div>
        <button onclick="resetData()" style="color:var(--error); background:none; border:none; margin-top:30px; cursor:pointer; width:100%; font-size:12px;">Reset All Data</button>
    </div>

    <div id="quizArea" class="card hidden">
        <div style="display:flex; justify-content:space-between;">
            <span id="qCount" style="font-weight:bold; color:var(--primary);">ප්‍රශ්නය 1/20</span>
            <div class="timer-box">කාලය: <span id="timer">20</span>s</div>
        </div>
        <div class="progress-container"><div id="pBar" class="progress-bar"></div></div>
        <h3 id="qTxt" style="text-align: left; margin-bottom: 20px;">ප්‍රශ්නය මෙතැන දිස්වේ...</h3>
        <div id="optCont"></div>
        <button id="nextBtn" class="action-btn hidden" onclick="nextQuestion()">මීළඟ ප්‍රශ්නය</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('ss_pro_data')) || null;
    let currentSub = "", currentIdx = 0, score = 0, timer = null;
    let myChart = null;
    let activeQuestions = [];

    const subjectsMap = {
        "6": ["විද්‍යාව", "ගණිතය", "ඉතිහාසය", "සිංහල"],
        "11": ["විද්‍යාව", "ගණිතය", "ඉතිහාසය", "සිංහල", "ICT"],
        "Bio": ["ජීව විද්‍යාව", "රසායන විද්‍යාව", "භෞතික විද්‍යාව"],
        "Maths": ["සංයුක්ත ගණිතය", "භෞතික විද්‍යාව", "රසායන විද්‍යාව"],
        "Commerce": ["ගිණුම්කරණය", "ව්‍යාපාර අධ්‍යයනය", "ආර්ථික විද්‍යාව"],
        "Art": ["සිංහල", "දේශපාලන විද්‍යාව", "ඉතිහාසය"],
        "Tech": ["ඉංජිනේරු තාක්ෂණය", "ජෛව පද්ධති තාක්ෂණය", "SFT"]
    };

    // ප්‍රශ්න පද්ධතිය (LaTeX උදාහරණ සහිතව)
    const questionsDB = {
        "විද්‍යාව": [
            {q: "ජල අණුවක රසායනික සූත්‍රය කුමක්ද?", o: ["$H_2O$", "$CO_2$", "$O_2$", "$NaCl$"], c: 0, ex: "ජලය සැදී ඇත්තේ හයිඩ්‍රජන් පරමාණු 2කින් සහ ඔක්සිජන් පරමාණු 1කිනි."},
            {q: "පරමාණුවක න්‍යෂ්ටිය තුළ පවතින්නේ?", o: ["ප්‍රෝටෝන හා ඉලෙක්ට්‍රෝන", "ප්‍රෝටෝන හා නියුට්‍රෝන", "නියුට්‍රෝන හා ඉලෙක්ට්‍රෝන", "ප්‍රෝටෝන පමණි"], c: 1, ex: "ප්‍රෝටෝන සහ නියුට්‍රෝන න්‍යෂ්ටියේ පවතී."},
            {q: "මිනිස් සිරුරේ විශාලතම ග්‍රන්ථිය?", o: ["අග්න්‍යාශය", "පිටියුටරිය", "අක්මාව", "තයිරොයිඩ්"], c: 2, ex: "අක්මාව සිරුරේ විශාලතම ග්‍රන්ථියයි."}
        ],
        "ගණිතය": [
            {q: "$2x + 10 = 20$ නම් $x$ හි අගය?", o: ["5", "10", "15", "20"], c: 0, ex: "$2x = 10$ නිසා $x = 5$ වේ."},
            {q: "ත්‍රිකෝණයක අභ්‍යන්තර කෝණවල එකතුව?", o: ["90°", "180°", "360°", "270°"], c: 1, ex: "ඕනෑම ත්‍රිකෝණයක කෝණ එකතුව 180° කි."}
        ]
    };

    function updateUI() {
        const grade = document.getElementById('gradeSelect').value;
        document.getElementById('alStreamDiv').className = (grade === "AL") ? "" : "hidden";
    }

    function saveSetup() {
        const grade = document.getElementById('gradeSelect').value;
        const days = document.getElementById('daysGoal').value;
        const stream = document.getElementById('streamSelect').value;
        if(!days) return alert("කරුණාකර දින ගණන ඇතුළත් කරන්න.");

        db = {
            grade: (grade === "AL") ? stream : grade,
            totalDays: parseInt(days),
            totalScore: 0,
            history: []
        };
        localStorage.setItem('ss_pro_data', JSON.stringify(db));
        showDashboard();
    }

    function showDashboard() {
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('quizArea').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');

        document.getElementById('dLeft').innerText = Math.max(0, db.totalDays - db.history.length);
        document.getElementById('tScore').innerText = db.totalScore;

        const grid = document.getElementById('subjectGrid');
        grid.innerHTML = "";
        const subs = subjectsMap[db.grade] || subjectsMap["6"];
        subs.forEach(s => {
            const b = document.createElement('div');
            b.className = 'menu-btn';
            b.innerText = s;
            b.onclick = () => startQuiz(s);
            grid.appendChild(b);
        });
        renderChart();
    }

    function startQuiz(sub) {
        if (!questionsDB[sub]) {
            alert("මෙම විෂයට අදාළ ප්‍රශ්න තවමත් ඇතුළත් කර නැත.");
            return;
        }
        currentSub = sub;
        currentIdx = 0;
        score = 0;
        activeQuestions = [...questionsDB[sub]].sort(() => Math.random() - 0.5);
        
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('quizArea').classList.remove('hidden');
        loadQuestion();
    }

    function loadQuestion() {
        clearInterval(timer);
        if(currentIdx >= activeQuestions.length) {
            finishQuiz();
            return;
        }

        const q = activeQuestions[currentIdx];
        document.getElementById('qCount').innerText = `ප්‍රශ්නය ${currentIdx + 1}/${activeQuestions.length}`;
        document.getElementById('qTxt').innerHTML = q.q;
        document.getElementById('pBar').style.width = ((currentIdx)/activeQuestions.length)*100 + "%";
        
        const cont = document.getElementById('optCont');
        cont.innerHTML = "";
        document.getElementById('nextBtn').classList.add('hidden');

        q.o.forEach((opt, i) => {
            const d = document.createElement('div');
            d.className = 'option';
            d.innerHTML = `<span>${opt}</span><div class="explanation">${q.ex}</div>`;
            d.onclick = () => selectOption(i, q.c, d);
            cont.appendChild(d);
        });

        // MathJax Render කිරීම
        if(window.MathJax) MathJax.typeset();
        startTimer();
    }

    function startTimer() {
        let timeLeft = 20;
        document.getElementById('timer').innerText = timeLeft;
        timer = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = timeLeft;
            if(timeLeft <= 0) {
                clearInterval(timer);
                selectOption(-1, activeQuestions[currentIdx].c, null);
            }
        }, 1000);
    }

    function selectOption(idx, correct, el) {
        clearInterval(timer);
        const opts = document.querySelectorAll('.option');
        opts.forEach(o => o.style.pointerEvents = 'none');

        if(idx === correct) {
            if(el) el.classList.add('correct');
            score += 10;
        } else {
            if(el) el.classList.add('wrong');
            opts[correct].classList.add('correct');
        }
        document.querySelectorAll('.explanation').forEach(ex => ex.style.display = 'block');
        document.getElementById('nextBtn').classList.remove('hidden');
    }

    function nextQuestion() {
        currentIdx++;
        loadQuestion();
    }

    function finishQuiz() {
        db.totalScore += score;
        db.history.push({ day: db.history.length + 1, score: score });
        localStorage.setItem('ss_pro_data', JSON.stringify(db));
        alert(`අවසන්! ලකුණු: ${score}`);
        showDashboard();
    }

    function renderChart() {
        const ctx = document.getElementById('progChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: db.history.map(h => "දිනය " + h.day),
                datasets: [{ 
                    label: 'ලකුණු', 
                    data: db.history.map(h => h.score), 
                    borderColor: '#58a6ff', 
                    backgroundColor: 'rgba(88, 166, 255, 0.1)',
                    fill: true,
                    tension: 0.3 
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: '#30363d' } },
                    x: { grid: { color: '#30363d' } }
                }
            }
        });
    }

    function resetData() { if(confirm("සියලු දත්ත මකන්නද?")) { localStorage.clear(); location.reload(); } }
    if(db) showDashboard();
</script>

</body>
</html>
